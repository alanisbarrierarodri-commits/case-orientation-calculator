<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SSTK Case Orientation Calculator</title>
<style>
  :root {
    --walmart-blue: #0071ce;
    --walmart-yellow: #ffc220;
    --light-gray: #f5f5f5;
  }
  body { font-family: Arial, sans-serif; margin: 0; background: var(--light-gray); }
  header { background: var(--walmart-blue); color: white; padding: 15px; text-align: center; font-size: 1.4em; font-weight: bold; }
  .container { background: white; max-width: 640px; margin: 20px auto; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
  .page { display: none; }
  label { font-weight: bold; display: block; margin-top: 10px; }
  input { width: 100%; padding: 10px; margin: 5px 0 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; }
  button {
    padding: 10px 16px; margin: 8px 4px 0 0;
    background: var(--walmart-yellow); color: black; font-weight: bold;
    border: none; border-radius: 8px; font-size: 1em; transition: background 0.2s;
  }
  button:hover { background: #e6ac00; cursor: pointer; }
  .results-container { margin-top: 10px; display: flex; flex-direction: column; gap: 20px; max-height: 500px; overflow-y: auto; padding-right: 8px; }
  .result-card { border: 2px solid var(--walmart-blue); border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); padding: 15px; background: #f8fbff; }
  .result-header { font-size: 1.1em; font-weight: bold; color: white; background: var(--walmart-blue); padding: 6px 10px; border-radius: 8px; margin-bottom: 8px; }
  .result-metrics span { display: inline-block; margin-right: 15px; font-weight: bold; color: #333; }
  .result-metrics .highlight { color: var(--walmart-yellow); }
  .view-container { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px; }
  .view { border: 1px solid #ccc; background: white; padding: 8px; border-radius: 8px; text-align: center; }
  canvas { display:block; max-width:100%; height:auto; }
</style>
</head>
<body>
<header>SSTK Case Orientation Calculator</header>
<div class="container">

  <!-- PAGE 1 -->
  <div class="page" id="page-1" style="display:block;">
    <label for="itemNumber">Item #:</label>
    <input type="text" id="itemNumber">
    <div style="text-align: center; margin: 10px 0;">
      <img src="https://github.com/alanisbarrierarodri-commits/case-orientation-calculator/blob/main/item.png?raw=true"
           alt="Item Image" style="max-width:100%; border-radius:8px;">
    </div>
    <button onclick="nextPage()">Next</button>
  </div>

  <!-- PAGE 2 -->
  <div class="page" id="page-2">
    <div style="margin: 15px 0; padding: 10px; background:#fff3cd; border-left:5px solid #ffc107;">
      <strong>Before measuring:</strong><br>
      • Round up half inches.<br>
      • Measure as case sits on pallet.<br>
      • If case has <strong>upright arrows</strong>, measure upright.
    </div>
    <div style="text-align: center; margin: 10px 0;">
      <img src="https://github.com/alanisbarrierarodri-commits/case-orientation-calculator/blob/main/measurement.png?raw=true"
           alt="Measurement Guide" style="max-width:100%; border-radius:8px;">
    </div>
    <label for="height">Height (inches):</label>
    <input type="number" id="height" step="0.01">
    <label for="length">Length (inches):</label>
    <small>Longest side</small>
    <input type="number" id="length" step="0.01">
    <label for="width">Width (inches):</label>
    <small>Shortest side</small>
    <input type="number" id="width" step="0.01">
    <button onclick="prevPage()">Previous</button>
    <button onclick="nextPage()">Next</button>
  </div>

  <!-- PAGE 3 -->
  <div class="page" id="page-3">
    <label>Select Slot Sizes (choose one or more):</label>
    <div id="slot-options">
      <label><input type="checkbox" value="30"> 30"</label><br>
      <label><input type="checkbox" value="40"> 40"</label><br>
      <label><input type="checkbox" value="50"> 50"</label><br>
      <label><input type="checkbox" value="60"> 60"</label><br>
      <label><input type="checkbox" value="71"> 71"</label><br>
      <label><input type="checkbox" value="73"> 73"</label><br>
      <label><input type="checkbox" value="75"> 75"</label><br>
      <label><input type="checkbox" value="110"> 110"</label><br>
    </div>
    <button onclick="prevPage()">Previous</button>
    <button onclick="calculate()">Calculate</button>
  </div>

  <!-- PAGE 4 -->
  <div class="page" id="page-4">
    <div class="results-container" id="results"></div>
    <!-- ✅ Send to QA button -->
    <button id="sendQA" onclick="sendToQA()">Send to QA</button>
    <button onclick="prevPage()">Previous</button>
  </div>

</div>

<script>
/* ---------- Page Navigation ---------- */
let lastResults = []; // holds TI/HI/Total per slot
let currentPage = 1;
function showPage(n) {
  document.querySelectorAll('.page').forEach((p, i) => {
    p.style.display = (i + 1 === n) ? 'block' : 'none';
  });
  currentPage = n;
}
function nextPage() { if (currentPage < 4) showPage(currentPage + 1); }
function prevPage() { if (currentPage > 1) showPage(currentPage - 1); }

/* ---------- Packing Strategies ---------- */
function packAllUnrotated(palletL,palletW,boxL,boxW){const fitL=Math.floor(palletL/boxL);const fitW=Math.floor(palletW/boxW);const placements=[];for(let i=0;i<fitL;i++){for(let j=0;j<fitW;j++){placements.push({x:i*boxL,y:j*boxW,w:boxL,h:boxW,rot:0});}}return placements;}
function packAllRotated(palletL,palletW,boxL,boxW){const fitL=Math.floor(palletL/boxW);const fitW=Math.floor(palletW/boxL);const placements=[];for(let i=0;i<fitL;i++){for(let j=0;j<fitW;j++){placements.push({x:i*boxW,y:j*boxL,w:boxW,h:boxL,rot:1});}}return placements;}
function packAlternatingRows(palletL,palletW,boxL,boxW){const placements=[];let y=0;let toggle=false;while(y+Math.min(boxW,boxL)<=palletW){if(!toggle){const fitL=Math.floor(palletL/boxL);for(let i=0;i<fitL;i++){placements.push({x:i*boxL,y,w:boxL,h:boxW,rot:0});}y+=boxW;}else{const fitL=Math.floor(palletL/boxW);for(let i=0;i<fitL;i++){placements.push({x:i*boxW,y,w:boxW,h:boxL,rot:1});}y+=boxL;}toggle=!toggle;}return placements;}
function packLayer(palletL,palletW,boxL,boxW){let freeRects=[{x:0,y:0,w:palletL,h:palletW}];const placements=[];const boxArea=boxL*boxW;while(true){let best=null;for(let ri=0;ri<freeRects.length;ri++){const r=freeRects[ri];if(boxL<=r.w&&boxW<=r.h){const waste=r.w*r.h-boxArea;if(!best||waste<best.waste)best={ri,place:{x:r.x,y:r.y,w:boxL,h:boxW},rot:0,waste};}if(boxW<=r.w&&boxL<=r.h){const waste=r.w*r.h-boxArea;if(!best||waste<best.waste)best={ri,place:{x:r.x,y:r.y,w:boxW,h:boxL},rot:1,waste};}}if(!best)break;placements.push({...best.place,rot:best.rot});const used=freeRects[best.ri];freeRects.splice(best.ri,1);const rightW=used.w-best.place.w;if(rightW>0)freeRects.push({x:used.x+best.place.w,y:used.y,w:rightW,h:best.place.h});const bottomH=used.h-best.place.h;if(bottomH>0)freeRects.push({x:used.x,y:used.y+best.place.h,w:used.w,h:bottomH});}return placements;}
function chooseBestPacking(palletL,palletW,boxL,boxW){const strategies=[{name:"All Unrotated",placements:packAllUnrotated(palletL,palletW,boxL,boxW)},{name:"All Rotated",placements:packAllRotated(palletL,palletW,boxL,boxW)},{name:"Alternating Rows",placements:packAlternatingRows(palletL,palletW,boxL,boxW)},{name:"Greedy Mixed",placements:packLayer(palletL,palletW,boxL,boxW)}];const palletArea=palletL*palletW;strategies.forEach(s=>{const usedArea=s.placements.reduce((sum,p)=>sum+p.w*p.h,0);s.cases=s.placements.length;s.whitespace=palletArea-usedArea;});strategies.sort((a,b)=>b.cases!==a.cases?b.cases-a.cases:a.whitespace-b.whitespace);return strategies[0];}

/* ---------- Main Calculate ---------- */
function calculate() {
  lastResults = [];
  const boxLength = parseFloat(document.getElementById('length').value);
  const boxWidth = parseFloat(document.getElementById('width').value);
  const boxHeight = parseFloat(document.getElementById('height').value);
  const palletLength = 47, palletWidth = 40;
  const slotSizes = [...document.querySelectorAll('#slot-options input:checked')].map(el => parseInt(el.value));
  const resultsContainer = document.getElementById('results');
  resultsContainer.innerHTML = "";

  if (isNaN(boxLength) || isNaN(boxWidth) || isNaN(boxHeight) ||
      boxLength <= 0 || boxWidth <= 0 || boxHeight <= 0) {
    resultsContainer.innerHTML = "<div class='result-card'>Please enter valid positive numbers.</div>";
    showPage(4); return;
  }
  if (slotSizes.length === 0) {
    resultsContainer.innerHTML = "<div class='result-card'>Please select at least one slot size.</div>";
    showPage(4); return;
  }

  slotSizes.forEach(slotHeight=>{
    const hi = Math.floor(slotHeight / boxHeight);
    if (hi<=0) {
      resultsContainer.innerHTML += `<div class='result-card'><div class="result-header">Slot Size: ${slotHeight}"</div><div>No layers fit (too tall).</div></div>`;
      return;
    }
    const best = chooseBestPacking(palletLength, palletWidth, boxLength, boxWidth);
    const ti = best.cases;
    const total = ti*hi;
    lastResults.push({slotHeight, TI: ti, HI: hi, Total: total, Strategy: best.name});

    const card=document.createElement('div');
    card.className="result-card";
    card.innerHTML=`
      <div class="result-header">Slot Size: ${slotHeight}"</div>
      <div class="result-metrics">
        <span>TI: <span class="highlight">${ti}</span></span>
        <span>HI: <span class="highlight">${hi}</span></span>
        <span>Total: <span class="highlight">${total}</span></span>
      </div>
      <div style="margin:10px 0; padding:8px; background:#fff3cd; border-left:4px solid #ffc107; border-radius:6px; font-size:0.9em;">
        Strategy: <strong>${best.name}</strong>
      </div>
    `;
    resultsContainer.appendChild(card);
  });

  showPage(4);
}

/* ---------- Send To QA ---------- */
async function sendToQA() {
  const payload = {
    itemNumber: document.getElementById('itemNumber').value,
    length: document.getElementById('length').value,
    width:  document.getElementById('width').value,
    height: document.getElementById('height').value,
    slotResults: lastResults // array of TI/HI results
  };

  try {
    const resp = await fetch('/api/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    console.log(data);
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.error || 'Error sending to Smartsheet');
    alert('✅ Sent to Smartsheet!');
  } catch (err) {
    console.error(err);
    alert('❌ Failed to send to Smartsheet');
  }
}
</script>
</body>
</html>
