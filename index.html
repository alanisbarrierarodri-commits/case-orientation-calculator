<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SSTK Case Orientation Calculator</title>
<style>
  :root {
    --walmart-blue: #0071ce;
    --walmart-yellow: #ffc220;
    --light-gray: #f5f5f5;
  }
  body { font-family: Arial, sans-serif; margin: 0; background: var(--light-gray); }
  header { background: var(--walmart-blue); color: white; padding: 15px; text-align: center; font-size: 1.4em; font-weight: bold; }
  .container { background: white; max-width: 640px; margin: 20px auto; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); }
  .page { display: none; }
  label { font-weight: bold; display: block; margin-top: 10px; }
  input, select { width: 100%; padding: 10px; margin: 5px 0 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; }
  button {
    padding: 10px 16px; margin: 8px 4px 0 0;
    background: var(--walmart-yellow); color: black; font-weight: bold;
    border: none; border-radius: 8px; font-size: 1em; transition: background 0.2s;
  }
  button:hover { background: #e6ac00; cursor: pointer; }
  .results-container { margin-top: 10px; display: flex; flex-direction: column; gap: 20px; max-height: 500px; overflow-y: auto; padding-right: 8px; }
  .result-card { border: 2px solid var(--walmart-blue); border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); padding: 15px; background: #f8fbff; }
  .result-header { font-size: 1.1em; font-weight: bold; color: white; background: var(--walmart-blue); padding: 6px 10px; border-radius: 8px; margin-bottom: 8px; }
  .result-metrics span { display: inline-block; margin-right: 15px; font-weight: bold; color: #333; }
  .result-metrics .highlight { color: var(--walmart-yellow); }
  canvas { display:block; max-width:100%; height:auto; margin-top:10px; border:1px solid #ccc; border-radius:6px; background:#e0e0e0; }
</style>
</head>
<body>
<header>SSTK Case Orientation Calculator</header>
<div class="container">

  <!-- PAGE 1 -->
  <div class="page" id="page-1" style="display:block;">
    <label for="dcNumber">DC:</label>
    <select id="dcNumber">
      <option value="7035">7035</option>
    </select>

    <label for="itemNumber">Item #:</label>
    <input type="text" id="itemNumber">
    <div style="text-align: center; margin: 10px 0;">
      <img src="https://github.com/alanisbarrierarodri-commits/case-orientation-calculator/blob/main/item.png?raw=true"
           alt="Item Image" style="max-width:100%; border-radius:8px;">
    </div>
    <button onclick="nextPage()">Next</button>
  </div>

  <!-- PAGE 2 -->
  <div class="page" id="page-2">
    <div style="margin: 15px 0; padding: 10px; background:#fff3cd; border-left:5px solid #ffc107;">
      <strong>Before measuring:</strong><br>
      • Round up half inches.<br>
      • Measure as case sits on pallet.<br>
      • If case has <strong>upright arrows</strong>, measure upright.
    </div>
    <div style="text-align: center; margin: 10px 0;">
      <img src="https://github.com/alanisbarrierarodri-commits/case-orientation-calculator/blob/main/measurement.png?raw=true"
           alt="Measurement Guide" style="max-width:100%; border-radius:8px;">
    </div>
    <div style="text-align: center; margin: 10px 0;">
      <img src="https://github.com/alanisbarrierarodri-commits/case-orientation-calculator/blob/main/upright.jpg?raw=true"
           alt="Upright Guide" style="max-width:100%; border-radius:8px;">
    </div>
    <label for="height">Height (inches):</label>
    <input type="number" id="height" step="0.01">
    <label for="length">Length (inches):</label>
    <small>Longest side</small>
    <input type="number" id="length" step="0.01">
    <label for="width">Width (inches):</label>
    <small>Shortest side</small>
    <input type="number" id="width" step="0.01">
    <button onclick="prevPage()">Previous</button>
    <button onclick="nextPage()">Next</button>
  </div>

  <!-- PAGE 3 -->
  <div class="page" id="page-3">
    <label>Select Slot Sizes (choose one or more):</label>
    <div id="slot-options">
      <label><input type="checkbox" value="30"> 30"</label><br>
      <label><input type="checkbox" value="40"> 40"</label><br>
      <label><input type="checkbox" value="50"> 50"</label><br>
      <label><input type="checkbox" value="60"> 60"</label><br>
      <label><input type="checkbox" value="71"> 71"</label><br>
      <label><input type="checkbox" value="73"> 73"</label><br>
      <label><input type="checkbox" value="75"> 75"</label><br>
      <label><input type="checkbox" value="110"> 110"</label><br>
    </div>
    <button onclick="prevPage()">Previous</button>
    <button onclick="calculate()">Calculate</button>
  </div>

  <!-- PAGE 4 -->
  <div class="page" id="page-4">
    <div class="results-container" id="results"></div>
    <button id="sendQA" onclick="sendToQA()">Send to QA</button>
    <button onclick="prevPage()">Previous</button>
  </div>

</div>

<script>
/* ---------- Page Navigation ---------- */
let lastResults = [];
let currentPage = 1;
function showPage(n){document.querySelectorAll('.page').forEach((p,i)=>p.style.display=(i+1===n)?'block':'none');currentPage=n;}
function nextPage(){if(currentPage<4)showPage(currentPage+1);}
function prevPage(){if(currentPage>1)showPage(currentPage-1);}

/* ---------- Packing Strategies with boundary checks ---------- */
function packSimple(pl, pw, bl, bw) {
  // ✅ Helper: count how many cases fit along a side (with 85% tolerance)
  const tolerance = 0.70;
function fitCount(palletSide, caseSide) {
  const exact = palletSide / caseSide;
  const whole = Math.floor(exact);
  const decimal = exact - whole;
  return decimal >= tolerance ? whole + 1 : whole;
}



  // Option 1: case long side along pallet long side
  const opt1_L = fitCount(pl, bl);
  const opt1_W = fitCount(pw, bw);
  const opt1_T = opt1_L * opt1_W;

  // Option 2: case short side along pallet long side (rotated)
  const opt2_L = fitCount(pl, bw);
  const opt2_W = fitCount(pw, bl);
  const opt2_T = opt2_L * opt2_W;

  // Pick whichever fits more full cases
  const useRotation = opt2_T >= opt1_T;

  const placements = [];
  if (!useRotation) {
    for (let i = 0; i < opt1_L; i++) {
      for (let j = 0; j < opt1_W; j++) {
        placements.push({ x: i * bl, y: j * bw, w: bl, h: bw, rot: 0 });
      }
    }
  } else {
    for (let i = 0; i < opt2_L; i++) {
      for (let j = 0; j < opt2_W; j++) {
        placements.push({ x: i * bw, y: j * bl, w: bw, h: bl, rot: 1 });
      }
    }
  }

  return { placements, cases: placements.length };
}

function packMixed(pl, pw, bl, bw) {
  const placements = [];
  let y = 0;
  let totalCases = 0;
  let rowIndex = 0;

  // Alternate rows between unrotated and rotated orientation
  while (y + Math.min(bw, bl) <= pw + 0.1) { // slight tolerance for rounding
    const isRotated = rowIndex % 2 === 1;
    const caseL = isRotated ? bw : bl;
    const caseW = isRotated ? bl : bw;

    // stop if next row exceeds pallet width
    if (y + caseW > pw + 0.1) break;

    const fitL = Math.floor(pl / caseL);
    if (fitL <= 0) break;

    for (let i = 0; i < fitL; i++) {
      placements.push({
        x: i * caseL,
        y: y,
        w: caseL,
        h: caseW,
        rot: isRotated ? 1 : 0
      });
      totalCases++;
    }

    y += caseW;
    rowIndex++;
  }

  return { name: "True Mixed", placements, cases: totalCases };
}

/* ---------- Calculate + Draw ---------- */
function calculate() {
    lastResults = [];
    const bl = parseFloat(document.getElementById('length').value);
    const bw = parseFloat(document.getElementById('width').value);
    const bh = parseFloat(document.getElementById('height').value);

    const palletL = 48, palletW = 40;

    const slots = [...document.querySelectorAll('#slot-options input:checked')]
        .map(e => parseInt(e.value));
    const results = document.getElementById('results');
    results.innerHTML = "";

    if ([bl, bw, bh].some(v => isNaN(v) || v <= 0)) {
        results.innerHTML = "<div class='result-card'>Please enter valid positive numbers.</div>";
        showPage(4); return;
    }
    if (slots.length === 0) {
        results.innerHTML = "<div class='result-card'>Please select at least one slot size.</div>";
        showPage(4); return;
    }

    // --- Compare multiple packing strategies ---
    const strategies = [
      { name: "Simple", ...packSimple(palletL, palletW, bl, bw) },
      { name: "True Mixed", ...packMixed(palletL, palletW, bl, bw) }
    ];
    
    // --- Choose best: most cases, then least whitespace (if you want to add that later) ---
    strategies.sort((a, b) => b.cases - a.cases);
    const best = strategies[0];


    // --- Render results for each slot size ---
    slots.forEach(slot => {
    const hi = Math.floor(slot / bh);
    if (hi <= 0) {
        results.innerHTML += `<div class='result-card'>
          <div class="result-header">Slot Size: ${slot}"</div>
          <div>No layers fit (too tall).</div></div>`;
        return;
    }
  
    const ti = best.cases, total = ti * hi;
    lastResults.push({ slotHeight: slot, TI: ti, HI: hi, Total: total, Strategy: best.name });
  
    const card = document.createElement('div');
    card.className = "result-card";
    card.innerHTML = `<div class="result-header">Slot Size: ${slot}"</div>
    <div class="result-metrics">
        <span>TI (per layer): <span class="highlight">${ti}</span></span>
        <span>HI (layers): <span class="highlight">${hi}</span></span>
        <span>Total: <span class="highlight">${total}</span></span>
    </div>`;
  
    // Canvas for pallet view
    const canvas = document.createElement('canvas');
    canvas.width = 400;
    canvas.height = 360;
    card.appendChild(canvas);
    const ctx = canvas.getContext('2d');
  
    const palletL = 48, palletW = 40;
  
    // Determine actual used pallet area (no confusing empty space)
    const usedL = Math.max(...best.placements.map(p => p.x + p.w), 0);
    const usedW = Math.max(...best.placements.map(p => p.y + p.h), 0);
  
    // Scaling based on full pallet, but draw only used area
    const scaleX = canvas.width / palletL;
    const scaleY = (canvas.height - 40) / palletW;
    const visibleHeight = usedW * scaleY;
  
    // Clear canvas and draw adjusted pallet outline
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;
    ctx.strokeRect(0, 0, usedL * scaleX, visibleHeight);
  
    // Draw each case (no misleading gray area at end)
    best.placements.forEach(p => {
        ctx.fillStyle = p.rot ? '#0071ce' : '#ffc220';
        ctx.fillRect(p.x * scaleX, p.y * scaleY, p.w * scaleX, p.h * scaleY);
        ctx.strokeStyle = "#000";
        ctx.strokeRect(p.x * scaleX, p.y * scaleY, p.w * scaleX, p.h * scaleY);
    });
  
    // Label bottom (always centered for full pallet)
    ctx.fillStyle = "#000";
    ctx.font = "14px Arial";
    const bottomText = "Pallet's Longest Side";
    const bottomWidth = ctx.measureText(bottomText).width;
    ctx.fillText(bottomText, (canvas.width - bottomWidth) / 2, canvas.height - 5);
  
    // Legend (unchanged)
    const legendContainer = document.createElement('div');
    legendContainer.style.marginTop = '10px';
    legendContainer.style.display = 'flex';
    legendContainer.style.gap = '20px';
    legendContainer.style.alignItems = 'center';
    legendContainer.style.paddingTop = '5px';
    legendContainer.style.borderTop = '1px solid #ccc';
  
    const unrotated = document.createElement('div');
    unrotated.style.display = 'flex';
    unrotated.style.alignItems = 'center';
    unrotated.innerHTML = `
      <div style="width:20px;height:20px;background:#ffc220;margin-right:8px;border:1px solid #000;"></div>
      <div>
        Case’s <strong>longest side (Length)</strong><br>
        aligned with pallet’s <strong>longest side</strong>
      </div>`;
    legendContainer.appendChild(unrotated);
  
    const rotated = document.createElement('div');
    rotated.style.display = 'flex';
    rotated.style.alignItems = 'center';
    rotated.innerHTML = `
      <div style="width:20px;height:20px;background:#0071ce;margin-right:8px;border:1px solid #000;"></div>
      <div>
        Case’s <strong>shortest side (Width)</strong><br>
        aligned with pallet’s <strong>longest side</strong>
      </div>`;
    legendContainer.appendChild(rotated);
  
    card.appendChild(legendContainer);
    results.appendChild(card);
  });


    showPage(4);
}


/* ---------- Send To QA ---------- */
async function sendToQA(){
    const payload={
        dcNumber:document.getElementById('dcNumber').value,
        itemNumber:document.getElementById('itemNumber').value,
        length:document.getElementById('length').value,
        width:document.getElementById('width').value,
        height:document.getElementById('height').value,
        slotResults:lastResults
    };
    try{
        const resp = await fetch('/api/submit',{
            method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
        });
        const data = await resp.json();
        if(!resp.ok) throw new Error(data.error||'Error sending to QA');
        alert('✅ Sent to QA!');
    }catch(err){
        console.error(err);
        alert('❌ Failed to send to QA');
    }
}
</script>
</body>
</html>


